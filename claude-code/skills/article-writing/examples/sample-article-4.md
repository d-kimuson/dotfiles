# サンプル記事4: Visual Regression Testing の内製化への道

この記事は実際に執筆された技術記事のサンプルです。文体のスタイル参考として使用してください。

---

## はじめに

こんにちは！カイポケリニューアルの開発推進チームでエンジニアをしている [@_kimuson](https://x.com/_kimuson) です。

フロントエンド開発において視覚的リグレッションテスト（Visual Regression Testing、以下 VRT）は欠かせない存在です。 私たちのチームでは長らく**Chromatic**を活用してきましたが、プロジェクトの成長に伴い、よりスケーラブルでコスト効率の高いソリューションを模索する必要が出てきました。

本記事は 2 部構成の前編として、内製化の決断に至った背景と代替ツールの検討過程を紹介します。 後編では実際の実装プロセスと移行作業の詳細に焦点を当てる予定です。

## 内製化の決断

### Chromatic の利点

Chromatic は Storybook をベースにした VRT を提供する SaaS です。 簡単なセットアップで優れた開発者体験と直感的なインターフェースを提供しています。

私たちのチームが特に価値を感じていた点は以下の通りです：

- 最小限のセットアップのみで Storybook をベースにした VRT を動かすことができる
  - VRT のしきい値も効果的に設定されており、特にチューニングせずとも Flaky（不安定な）テストを最小限に抑えられている
- わかりやすい差分の表示と、Story 単位での変更承認/拒否の柔軟なワークフロー
- VRT により、安全にフロントエンドを編集できる点
- コードレビューの際に変更によって UI がどう変更されるのかが自動でわかる開発者体験
- VRT に加えて Storybook がホスティングされ、非エンジニアに再現の難しい状態の UI を共有できる点

### 内製化を検討するきっかけ

最大の課題はコストでした。

我々のチームではスナップショットの総数が月あたり約 13 万スナップショットずつ増加しており、検証開始の時点で合計約 70 万スナップショットに達していました。 Chromatic の課金形態はスナップショット数に対する従量課金であり、スナップショットに対して線形に金額が増えていきます。プロジェクト規模に適したコスト構造を考え、内製化を検討するに至りました。

## 代替ツールの検討

内製化にあたって重要だったのは、Chromatic が提供していた価値をどう置き換えるかという点です。 代替ツールを検討する前に、まず Chromatic から得ていた主な価値を整理しました。

### Chromatic から得ていた価値

Chromatic は単なる VRT ツールにとどまらず、フロントエンドの開発フローおよび品質保証に幅広く価値を提供しています。

特に以下の 3 つの価値が重要でした：

1. **リグレッションの検知**
   - UI に意図しない変更が入っていないかを自動的に検知
   - 継続的な品質保証の基盤

2. **開発体験の向上**
   - PR の変更によって UI にどのような影響があるかを視覚的に確認
   - Story 単位での変更承認/拒否により、コンポーネントごとの細かなレビューが可能

3. **Storybook 共有によるコミュニケーション基盤**
   - デザイナーやプロダクトマネージャーとのコミュニケーションツールとして機能
   - 再現が難しい条件の UI 状態も、Storybook でパラメータを固定して共有可能
   - コンポーネントの全バリエーションを一覧できるカタログとしての役割

### Storybook のホスティングを代替する

「Storybook 共有によるコミュニケーション基盤」について、Storybook 自体は静的な配信に対応しています。

ですので、単に「ブランチごとにビルドをして AWS S3 等のホスティングが行えるサービスでホスティングする」仕組みだけ作れれば良いので、GitHub Actions で AWS S3 にアップロードするワークフローを組むことで対応できる見立てが立ちました。

### VRT の実行およびレポート確認を代替する

#### Storycap + reg-suit

Storycap と reg-suit の組み合わせは、オープンソースで VRT を実現する広く使われているオプションです。

VRT の実現には、大きく分けて
1. スクリーンショットを撮影する部分
2. UI の差分を検知する部分
3. レポートを表示する部分

の要素が必要ですが、Storycap が 1 の撮影部分を、reg-suit が 2 と 3 の差分の検知とレポート部分をカバーします。

#### Lost Pixel

Lost Pixel は Storybook ベースの VRT を実現する他のツールとして検証しました。Platform 版（SaaS）と OSS 版の 2 つの選択肢がありますが、OSS 版を検討しました。

## 技術比較と選定

上記の検証結果を踏まえ、**Storycap + reg-suit** の構成を取ることに決めました。

理由:
- スクリーンショットの capture: Lost Pixel は実行時間のスケーリングに課題があり、sharding が不可能な点が致命的
- リグレッション検知・レポート: reg-suit はレポート画面があり、開発者の生産性を最大限維持できると判断

## まとめ

Chromatic からの移行を検討する過程で、複数の VRT を提供する OSS とアプローチを検証しました。 その結果、コスト削減効果と開発者体験のバランスから、Storycap + reg-suit の組み合わせが最適であるという結論に至りました。

主な決め手となったポイントは以下の通りです：
1. **大幅なコスト削減**
2. **許容可能な開発者体験**
3. **現実的な CI の実行時間の維持**

### 次回予告

後編では、Storycap + reg-suit を使ったワークフローを実際に構築していく際の工夫した点や移行のプロセスについて紹介する予定です！
