# オーケストレーションパターン詳細リファレンス

サブエージェントを使ったオーケストレーションワークフローのプロンプト設計ガイド。

## 呼び出しテンプレートの重要性

**重要要件: オーケストレーターは明示的な呼び出しテンプレートを必ず提供すること**

### テンプレートが不可欠な理由
1. **一貫性**: 毎回同じ呼び出しパターン、変動を減少
2. **再現性**: 将来のメンテナーが正確な呼び出し構造を確認可能
3. **明確性**: オーケストレーション契約を暗黙ではなく明示的に
4. **保守性**: サブエージェントの呼び出し方法の単一の信頼できる情報源
5. **発見可能性**: 新規ユーザーがすぐにパターンを理解可能

### テンプレートの良い例
```markdown
## 実装エージェントの呼び出し

このテンプレートを使用:

agent-task(
  agent="engineer",
  message="""
以下の機能を実装してください:
{feature_description}

要件:
{requirements}

受け入れ条件:
{acceptance_criteria}

プロジェクト規約に従い、テストを含めてください。
"""
)
```

## オーケストレーターとサブエージェント間の責任分割

**設計原則**: サブエージェントは単一目的だが多くのタスクで再利用可能。タスク固有のコンテキストはオーケストレーターのテンプレートに; 責任固有のプラクティスはサブエージェントに。

### サブエージェントプロンプト（責任固有、再利用可能）
- この責任に常に必要なコアプラクティス
- ドメイン固有の知識と制約
- このタイプのタスクの一般的なワークフロー
- このドメインのエラーハンドリングパターン
- この責任の品質基準

### オーケストレーターの呼び出しテンプレート（タスク固有、コンテキスト依存）
- 現在のタスクのコンテキストと背景
- タスク固有のルールと制約
- このタスクの特定の焦点領域または優先事項
- 他のワークフローステップとの統合要件
- 普遍的に適用できないプロジェクト固有の制約

## 具体例: コードレビューエージェント

### サブエージェントプロンプト（`.claude/agents/reviewer.md`）
```markdown
コード変更の品質と正確性をレビューする。

チェック項目:
- 型安全性と正確性
- セキュリティ脆弱性
- パフォーマンス問題
- コードスタイルの一貫性
- テストカバレッジの十分性

レポート形式:
- 重要度レベル（critical/moderate/minor）
- ファイルパスと行番号
- 具体的な推奨事項
- 優先順序（critical を先に）
```

### オーケストレーターのテンプレート
```markdown
agent-task(
  agent="reviewer",
  message="""
認証機能の実装をレビューしてください。

コンテキスト: HIPAA 下で PHI データを扱うヘルスケアアプリケーション。

このレビューの追加要件:
- HIPAA 準拠は critical（違反は critical として報告）
- すべてのデータベースクエリはパラメータ化ステートメントを使用
- セッショントークンは15分以内に期限切れ
- パスワードハッシュは cost factor ≥12 の bcrypt を使用

レビュー対象ファイル: src/auth/*.ts

セキュリティとコンプライアンス問題に集中。
"""
)
```

## 責任分割のための設計質問

### これはサブエージェントプロンプトに入れるべきか？
- このプラクティスはこのタイプのタスクに常に必要か？
- これはエージェントのコア責任を定義するか？
- このエージェントは処理するあらゆるタスクでこの知識が必要か？
- これはこの責任のためのドメイン固有の専門知識か？

→ **YES なら**: サブエージェントプロンプトに含める

### これはオーケストレーターのテンプレートに入れるべきか？
- これは現在のタスクまたはプロジェクト固有か？
- ワークフローの前のステップに依存するか？
- これは一時的な制約または優先事項か？
- オーケストレーションフローからのコンテキストが必要か？

→ **YES なら**: 呼び出しテンプレートに含める

### 例
- ✅ サブエージェント: "型エラーと未使用変数をチェック"
- ✅ オーケストレーター: "前のステップでリファクタした支払いモジュールに集中"
- ✅ サブエージェント: "セキュリティ脆弱性を重要度レベル付きで報告"
- ✅ オーケストレーター: "これはクレジットカードデータを扱う—PCI-DSS 準拠が critical"

## 追加考慮事項

### 失敗ハンドリング
- オーケストレーターはサブエージェントの失敗を gracefully に処理
- 重要タスクのリトライ戦略を定義
- サブエージェントからの明確なエラー報告

### テンプレート保守
- 呼び出しテンプレートを更新しやすいよう一箇所に保持
- サブエージェントプロンプト変更時、すべてのオーケストレーターテンプレートをレビュー
- 各サブエージェントの期待入出力を文書化
